<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø­Ø§ÙƒÙŠ Ù…ØµÙ†Ø¹ Ø§Ù„Ø±ÙˆØ¨ÙˆØªØ§Øª ÙˆØ§Ù„Ø­Ù„ÙˆÙŠØ§Øª Ø§Ù„Ø°ÙƒÙŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #fdf5e6;
            margin: 0;
            overflow: hidden;
            user-select: none;
        }

        #factory-canvas {
            display: block;
            background: radial-gradient(circle at center, #fff9f0 0%, #fdf5e6 100%);
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 30px rgba(121, 85, 72, 0.08);
        }

        .station-slot {
            width: 44px;
            height: 44px;
            border: 1.5px solid #D7CCC8;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: grab;
            border-radius: 12px;
            background: white;
            transition: all 0.2s ease;
        }

        .station-slot:hover {
            transform: scale(1.05);
            border-color: #A1887F;
        }

        .dragging {
            opacity: 0.3;
            transform: scale(0.8);
        }

        .glitch-btn {
            background: #ff7675;
            color: white;
            transition: all 0.3s ease;
        }

        .glitch-btn.active {
            background: #d63031;
            animation: pulse-red 1.5s infinite;
        }

        @keyframes pulse-red {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(0.98); }
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø®Ø§Øµ Ù„Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø± */
        .custom-scroll::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #D7CCC8;
            border-radius: 10px;
        }
    </style>
</head>
<body>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¹Ù„ÙˆÙŠØ© - ØªÙ… ØªØµØºÙŠØ±Ù‡Ø§ ÙˆÙˆØ¶Ø¹Ù‡Ø§ ÙÙŠ Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø­Ø¬Ø¨ -->
    <div class="fixed top-5 left-5 z-20 pointer-events-none">
        <div class="glass-panel p-4 rounded-[1.2rem] pointer-events-auto w-64">
            <div class="flex items-center gap-2 mb-3">
                <span class="text-xl">ğŸ­</span>
                <h1 class="text-sm font-bold text-[#5D4037]">Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØµÙ†Ø¹ Ø§Ù„Ø°ÙƒÙŠ</h1>
            </div>

            <div class="space-y-3">
                <div class="bg-white/40 p-2 rounded-xl">
                    <div class="flex justify-between text-[10px] mb-1 text-[#8D6E63] font-bold">
                        <span>ÙƒÙØ§Ø¡Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬</span>
                        <span id="quality-val" class="text-green-600">100%</span>
                    </div>
                    <div class="w-full bg-gray-200/50 h-1.5 rounded-full overflow-hidden">
                        <div id="quality-bar" class="bg-green-500 h-full transition-all duration-700" style="width: 100%"></div>
                    </div>
                </div>

                <div class="flex justify-between items-center bg-white/40 p-2 rounded-xl">
                    <span class="text-[11px] text-[#8D6E63]">Ø§Ù„Ù‚Ø·Ø¹ Ø§Ù„Ù…Ø´Ø­ÙˆÙ†Ø©:</span>
                    <span id="count-val" class="text-lg font-black text-[#5D4037]">0</span>
                </div>

                <button id="glitch-toggle" class="glitch-btn w-full py-2.5 rounded-xl text-[10px] font-bold pointer-events-auto flex items-center justify-center gap-2 shadow-sm">
                    <span>âš ï¸</span>
                    <span>Ù…Ø­Ø§ÙƒØ§Ø© Ø®Ù„Ù„ ØªÙ‚Ù†ÙŠ</span>
                </button>
            </div>
            
            <div class="mt-4 pt-3 border-t border-dashed border-[#D7CCC8]">
                <p class="text-[9px] font-bold mb-2 uppercase tracking-tight text-[#A1887F]">ØªØ³Ù„Ø³Ù„ Ø§Ù„Ù…Ø³Ø§Ø± (Ø§Ø³Ø­Ø¨ Ù„Ù„ØªØ±ØªÙŠØ¨)</p>
                <div id="sortable-stations" class="flex flex-wrap gap-1.5">
                    <div draggable="true" data-type="mix" class="station-slot text-base" title="Ø®Ù„Ø·">ğŸ¥£</div>
                    <div draggable="true" data-type="cool" class="station-slot text-base" title="ØªØ¨Ø±ÙŠØ¯">â„ï¸</div>
                    <div draggable="true" data-type="wrap" class="station-slot text-base" title="ØªØºÙ„ÙŠÙ">ğŸ</div>
                    <div draggable="true" data-type="check" class="station-slot text-base" title="ÙØ­Øµ">ğŸ”</div>
                    <div draggable="true" data-type="load" class="station-slot text-base" title="ØªØ¹Ø¨Ø¦Ø©">ğŸ“¦</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ´Ø®ÙŠØµ - ØªØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø±ÙˆØ¨ÙˆØª -->
    <div id="inspector-panel" class="fixed bottom-5 right-5 glass-panel p-4 rounded-[1.2rem] pointer-events-auto w-60 hidden z-20 animate-in fade-in slide-in-from-bottom-4 duration-300">
        <div class="flex items-center gap-2 mb-3 border-b border-[#D7CCC8] pb-2">
            <span id="inspected-icon" class="text-lg">ğŸ¤–</span>
            <h3 class="font-bold text-xs text-[#5D4037]">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©</h3>
        </div>
        <div id="robot-details" class="text-[10px] space-y-2 text-[#795548]">
            <!-- ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
        </div>
    </div>

    <!-- Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªØºØ°ÙŠØ© Ø§Ù„Ø±Ø§Ø¬Ø¹Ø© -->
    <div id="feedback-toast" class="fixed top-8 left-1/2 -translate-x-1/2 glass-panel px-6 py-2.5 rounded-full text-[#5D4037] text-xs font-bold opacity-0 transition-all duration-500 pointer-events-none shadow-lg border border-white">
        âœ¨ ØªÙ… Ø§Ù„Ø´Ø­Ù† Ø¨Ù†Ø¬Ø§Ø­
    </div>

    <canvas id="factory-canvas"></canvas>

<script>
    const canvas = document.getElementById('factory-canvas');
    const ctx = canvas.getContext('2d');
    const qualityVal = document.getElementById('quality-val');
    const qualityBar = document.getElementById('quality-bar');
    const countVal = document.getElementById('count-val');
    const feedback = document.getElementById('feedback-toast');
    const inspectorPanel = document.getElementById('inspector-panel');
    const robotDetails = document.getElementById('robot-details');
    const glitchBtn = document.getElementById('glitch-toggle');

    let width, height;
    let robots = [];
    let particles = [];
    let producedCount = 0;
    let factoryQuality = 100;
    let selectedRobot = null;
    let isGlitchActive = false;

    const STATION_TYPES = {
        mix: { label: 'Ø§Ù„Ø®Ù„Ø·', color: '#8D6E63', icon: 'ğŸ¥£', tempChange: 4 },
        cool: { label: 'Ø§Ù„ØªØ¨Ø±ÙŠØ¯', color: '#80DEEA', icon: 'â„ï¸', tempChange: -12 },
        wrap: { label: 'Ø§Ù„ØªØºÙ„ÙŠÙ', color: '#F48FB1', icon: 'ğŸ', tempChange: 0 },
        check: { label: 'Ø§Ù„ÙØ­Øµ', color: '#FFF176', icon: 'ğŸ”', tempChange: 1 },
        load: { label: 'Ø§Ù„ØªØ¹Ø¨Ø¦Ø©', color: '#A1887F', icon: 'ğŸ“¦', tempChange: 0 }
    };

    let currentSequence = ['mix', 'cool', 'wrap', 'check', 'load'];
    const IDEAL_SEQUENCE = ['mix', 'cool', 'wrap', 'check', 'load'];

    class Robot {
        constructor(id) {
            this.id = id;
            this.reset();
            this.x = Math.random() * width;
            this.y = Math.random() * height;
            this.rotation = Math.random() * Math.PI * 2;
        }

        reset() {
            this.targetStep = 0;
            this.progress = 0;
            this.temp = 24 + Math.random() * 6;
            this.vx = (Math.random() - 0.5) * 1;
            this.vy = (Math.random() - 0.5) * 1;
            this.currentChocolateQuality = 100;
            this.isBroken = false;
        }

        update() {
            if (isGlitchActive && Math.random() < 0.003) {
                this.isBroken = true;
            }

            if (this.isBroken) {
                this.vx += (Math.random() - 0.5) * 0.4;
                this.vy += (Math.random() - 0.5) * 0.4;
                this.temp += 0.05;
                this.currentChocolateQuality -= 0.08;
            } else {
                const targetType = currentSequence[this.targetStep];
                const targetStation = stations.find(s => s.type === targetType);
                
                if (!targetStation) return;

                const dx = targetStation.x - this.x;
                const dy = targetStation.y - this.y;
                const dist = Math.sqrt(dx*dx + dy*dy);

                if (dist < 35) {
                    this.progress += isGlitchActive ? 0.2 : 0.6;
                    this.temp += STATION_TYPES[targetType].tempChange * 0.03;
                    if (this.progress >= 100) this.completeStep();
                } else {
                    let speed = isGlitchActive ? 0.12 : 0.28;
                    this.vx += (dx / dist) * speed;
                    this.vy += (dy / dist) * speed;
                    this.rotation = Math.atan2(this.vy, this.vx);
                }
            }

            robots.forEach(other => {
                if (other === this) return;
                const d = Math.sqrt((other.x - this.x)**2 + (other.y - this.y)**2);
                if (d < 25) {
                    this.vx -= (other.x - this.x) * 0.06;
                    this.vy -= (other.y - this.y) * 0.06;
                }
            });

            this.vx *= 0.93;
            this.vy *= 0.93;
            this.x += this.vx;
            this.y += this.vy;
            
            if (this.x < 20 || this.x > width-20) this.vx *= -1;
            if (this.y < 20 || this.y > height-20) this.vy *= -1;
        }

        completeStep() {
            this.progress = 0;
            const currentTask = currentSequence[this.targetStep];
            
            if (currentTask !== IDEAL_SEQUENCE[this.targetStep]) {
                factoryQuality = Math.max(0, factoryQuality - 3);
            }

            this.targetStep++;
            if (this.targetStep >= currentSequence.length) {
                this.targetStep = 0;
                producedCount++;
                updateUI();
                createCelebration(this.x, this.y, STATION_TYPES[currentTask].color);
            }
        }

        draw() {
            const currentTask = currentSequence[this.targetStep];
            const color = this.isBroken ? '#616161' : STATION_TYPES[currentTask].color;

            ctx.save();
            ctx.translate(this.x, this.y);
            
            // Ø§Ù„Ø¬Ø³Ù…
            ctx.shadowBlur = this.isBroken ? 0 : 12;
            ctx.shadowColor = color + '66';
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.roundRect(-9, -9, 18, 18, 5);
            ctx.fill();
            
            // Ø§Ù„ÙˆØ¬Ù‡ ÙˆØ§Ù„Ø¹ÙŠÙˆÙ†
            ctx.rotate(this.rotation);
            ctx.fillStyle = this.isBroken ? '#ff5252' : 'white';
            ctx.beginPath();
            ctx.arc(4, -3, 2.2, 0, Math.PI * 2);
            ctx.arc(4, 3, 2.2, 0, Math.PI * 2);
            ctx.fill();

            // Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠ Ø§Ù„ØµØºÙŠØ±
            ctx.restore();
            if (!this.isBroken) {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.strokeStyle = '#D7CCC888';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(0, 0, 14, 0, Math.PI * 2);
                ctx.stroke();
                
                ctx.strokeStyle = color;
                ctx.beginPath();
                ctx.arc(0, 0, 14, -Math.PI/2, (-Math.PI/2) + (Math.PI * 2 * (this.progress/100)));
                ctx.stroke();
                ctx.restore();
            } else {
                ctx.fillStyle = "red";
                ctx.font = "bold 10px Arial";
                ctx.fillText("ERR", this.x - 10, this.y - 14);
            }
        }
    }

    let stations = [];
    function init() {
        resize();
        robots = Array.from({length: 10}, (_, i) => new Robot(i));
        animate();
    }

    function updateStationPositions() {
        // ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø­Ø·Ø§Øª Ø¨Ø¹ÙŠØ¯Ø§Ù‹ Ø¹Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„ÙŠØ³Ø±Ù‰ Ø§Ù„Ø¹Ù„ÙˆÙŠØ©
        stations = [
            { type: 'mix', x: width * 0.25, y: height * 0.45 },
            { type: 'cool', x: width * 0.55, y: height * 0.25 },
            { type: 'wrap', x: width * 0.85, y: height * 0.45 },
            { type: 'check', x: width * 0.70, y: height * 0.75 },
            { type: 'load', x: width * 0.40, y: height * 0.75 }
        ];
    }

    function resize() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
        updateStationPositions();
    }

    function drawStation(s) {
        const info = STATION_TYPES[s.type];
        ctx.save();
        
        ctx.fillStyle = 'white';
        ctx.shadowBlur = 15;
        ctx.shadowColor = 'rgba(0,0,0,0.04)';
        ctx.beginPath();
        ctx.roundRect(s.x - 35, s.y - 35, 70, 70, 18);
        ctx.fill();

        ctx.fillStyle = '#5D4037';
        ctx.font = '28px serif';
        ctx.textAlign = 'center';
        ctx.fillText(info.icon, s.x, s.y + 6);
        
        ctx.font = 'bold 10px Tajawal';
        ctx.fillStyle = '#A1887F';
        ctx.fillText(info.label, s.x, s.y + 30);
        
        ctx.restore();
    }

    function animate() {
        ctx.clearRect(0, 0, width, height);

        // Ø±Ø³Ù… Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ø±Ø¨Ø·
        ctx.setLineDash([4, 8]);
        ctx.strokeStyle = isGlitchActive ? '#ff767533' : '#D7CCC844';
        ctx.lineWidth = 1;
        ctx.beginPath();
        for(let i=0; i<currentSequence.length; i++) {
            const s = stations.find(st => st.type === currentSequence[i]);
            const nextS = stations.find(st => st.type === currentSequence[(i+1)%currentSequence.length]);
            ctx.moveTo(s.x, s.y);
            ctx.lineTo(nextS.x, nextS.y);
        }
        ctx.stroke();
        ctx.setLineDash([]);

        stations.forEach(drawStation);
        robots.forEach(r => { r.update(); r.draw(); });

        particles = particles.filter(p => p.life > 0);
        particles.forEach(p => {
            p.x += p.vx; p.y += p.vy; p.life -= 0.025;
            ctx.fillStyle = p.color;
            ctx.globalAlpha = p.life;
            ctx.beginPath(); ctx.arc(p.x, p.y, 2 * p.life, 0, Math.PI * 2); ctx.fill();
            ctx.globalAlpha = 1;
        });

        if (isGlitchActive) {
            factoryQuality = Math.max(5, factoryQuality - 0.015);
            updateUI();
        }

        requestAnimationFrame(animate);
    }

    glitchBtn.onclick = () => {
        isGlitchActive = !isGlitchActive;
        if (isGlitchActive) {
            glitchBtn.classList.add('active');
            glitchBtn.innerHTML = '<span>ğŸ› ï¸</span> <span>Ø¥ÙŠÙ‚Ø§Ù ÙˆØ¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¹Ø·Ù„</span>';
            showFeedback("ğŸš¨ ØªÙ… Ø±ØµØ¯ Ø®Ù„Ù„ ÙÙŠ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡!");
        } else {
            glitchBtn.classList.remove('active');
            glitchBtn.innerHTML = '<span>âš ï¸</span> <span>Ù…Ø­Ø§ÙƒØ§Ø© Ø®Ù„Ù„ ØªÙ‚Ù†ÙŠ</span>';
            robots.forEach(r => r.isBroken = false);
            showFeedback("âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù†Ø¸Ø§Ù…");
        }
    };

    const sortable = document.getElementById('sortable-stations');
    let draggedItem = null;

    sortable.addEventListener('dragstart', (e) => {
        draggedItem = e.target;
        e.target.classList.add('dragging');
    });

    sortable.addEventListener('dragend', (e) => {
        e.target.classList.remove('dragging');
        const children = Array.from(sortable.children);
        currentSequence = children.map(c => c.dataset.type);
    });

    sortable.addEventListener('dragover', (e) => {
        e.preventDefault();
        const afterElement = getDragAfterElement(sortable, e.clientX);
        if (afterElement == null) sortable.appendChild(draggedItem);
        else sortable.insertBefore(draggedItem, afterElement);
    });

    function getDragAfterElement(container, x) {
        const draggableElements = [...container.querySelectorAll('[draggable]:not(.dragging)')];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = x - box.left - box.width / 2;
            if (offset < 0 && offset > closest.offset) return { offset: offset, element: child };
            else return closest;
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function updateUI() {
        countVal.innerText = producedCount;
        qualityVal.innerText = `${Math.floor(factoryQuality)}%`;
        qualityBar.style.width = `${factoryQuality}%`;
        
        if (factoryQuality < 50) qualityBar.className = "bg-red-500 h-full transition-all duration-700";
        else if (factoryQuality < 80) qualityBar.className = "bg-orange-400 h-full transition-all duration-700";
        else qualityBar.className = "bg-green-500 h-full transition-all duration-700";
    }

    function showFeedback(text) {
        feedback.innerText = text;
        feedback.style.opacity = '1';
        feedback.style.transform = 'translateX(-50%) translateY(10px)';
        setTimeout(() => {
            feedback.style.opacity = '0';
            feedback.style.transform = 'translateX(-50%) translateY(0)';
        }, 2500);
    }

    function createCelebration(x, y, color) {
        for(let i=0; i<8; i++) {
            particles.push({
                x, y, vx: (Math.random() - 0.5) * 5, vy: (Math.random() - 0.5) * 5,
                color: color, life: 1
            });
        }
    }

    canvas.addEventListener('mousedown', (e) => {
        const rect = canvas.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;

        selectedRobot = robots.find(r => Math.sqrt((r.x - mouseX)**2 + (r.y - mouseY)**2) < 25);
        
        if (selectedRobot) {
            inspectorPanel.classList.remove('hidden');
            document.getElementById('inspected-icon').innerText = selectedRobot.isBroken ? 'âš ï¸' : 'ğŸ¤–';
            updateInspector();
        } else {
            inspectorPanel.classList.add('hidden');
        }
    });

    function updateInspector() {
        if (!selectedRobot || inspectorPanel.classList.contains('hidden')) return;
        robotDetails.innerHTML = `
            <div class="flex justify-between p-1.5 bg-white/50 rounded-lg"><span>Ø§Ù„Ù…Ø¹Ø±Ù:</span> <span class="font-mono">#${selectedRobot.id + 101}</span></div>
            <div class="flex justify-between p-1.5"><span>Ø§Ù„Ø­Ø§Ù„Ø©:</span> <span class="font-bold ${selectedRobot.isBroken ? 'text-red-500' : 'text-green-600'}">${selectedRobot.isBroken ? 'Ø¹Ø·Ù„ Ù…Ø­Ø±Ùƒ' : 'ÙŠØ¹Ù…Ù„'}</span></div>
            <div class="flex justify-between p-1.5"><span>Ø§Ù„Ø­Ø±Ø§Ø±Ø©:</span> <span class="${selectedRobot.temp > 42 ? 'text-orange-600' : ''}">${selectedRobot.temp.toFixed(1)}Â°C</span></div>
            <div class="flex justify-between p-1.5"><span>ÙƒÙØ§Ø¡Ø© Ø§Ù„ÙˆØ­Ø¯Ø©:</span> <span>${selectedRobot.currentChocolateQuality.toFixed(0)}%</span></div>
        `;
        requestAnimationFrame(updateInspector);
    }

    window.addEventListener('resize', resize);
    init();

</script>
</body>
</html>